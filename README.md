# 智能环境监控与安防系统
## 1. 系统总体架构
本系统采用分层架构设计，自下而上分别为：**硬件感知与执行层**、**主控逻辑层**、**网络通信层**、**云平台服务层**。

系统拓扑结构如下：
`[传感器/执行器] <--> [STM32主控制器] <--> [ESP8266 Wi-Fi模块] <--> [MQTT协议] <--> [OneNet云平台]`

## 2. 硬件架构
系统以STM32F103系列单片机为核心，外围模块主要分为传感器组、执行器组和通信显示模块。

| 模块类别 | 硬件型号 | 连接引脚/接口 | 功能描述 |
| :--- | :--- | :--- | :--- |
| **主控芯片** | STM32F103C8T6 | - | 系统的核心大脑，负责逻辑处理与调度 |
| **温湿度传感器**| DHT11 | GPIO | 单总线通信，采集环境温湿度 |
| **光照传感器** | 光敏电阻/ADC | ADC通道 (PA口) | 模拟量输出，检测光照强度 |
| **超声波传感器**| HC-SR04 | GPIO (Trig/Echo)| 测距，用于安防检测 |
| **Wi-Fi模块** | ESP8266-01S | UART2 (PA2/PA3) | AT指令集控制，负责TCP/IP网络通信 |
| **显示模块** | 0.96寸 OLED | I2C/SPI | 显示系统状态和传感器数据 |
| **报警模块** | 有源蜂鸣器 | GPIO | 触发报警声音 |
| **降温模块** | 直流电机+扇叶 | GPIO (驱动电路) | 模拟风扇/空调控制 |
| **照明模块** | LED | GPIO | 模拟家庭照明灯具 |

## 3. 软件架构
软件基于Keil MDK开发，采用模块化设计思想，没有使用复杂的RTOS，而是采用**前后台系统（主循环+中断）**架构。

### 3.1 软件层次结构
*   **应用层 (User)**: `main.c` 实现业务逻辑、自动化控制算法、数据刷新策略。
*   **协议层 (Network)**:
    *   `onenet.c`: 实现OneNet平台鉴权、Token生成、数据流封装。
    *   `mqttkit.c`: 实现MQTT协议的CONNECT, PUBLISH, SUBSCRIBE报文封装与解析。
*   **驱动层 (Device)**:
    *   `esp8266.c`: 封装AT指令，实现连接路由器、建立TCP连接、透传发送数据。
    *   `dht11.c`, `hcsr04.c`, `oled.c` 等: 封装底层GPIO操作，提供标准读写接口。
*   **硬件抽象层 (Library)**: STM32标准外设库 (Standard Peripheral Library)。

### 3.2 数据流向设计
1.  **上行数据**：传感器 -> STM32 (ADC/GPIO读取) -> JSON格式打包 -> MQTT Publish -> ESP8266 -> OneNet云端。
2.  **下行指令**：OneNet云端 -> MQTT Subscribe -> ESP8266 -> STM32解析 -> 控制GPIO -> 执行器动作。

## 4. 网络通信架构
*   **通信方式**：Wi-Fi (802.11 b/g/n)
*   **传输协议**：TCP/IP
*   **应用层协议**：MQTT (Message Queuing Telemetry Transport)
*   **鉴权机制**：Token鉴权 (基于HMAC-SHA1算法)
*   **云服务器**：中国移动OneNet物联网平台 (mqtts.heclouds.com:1883)
